<html>
  <body>
    <button onclick="start()">Start!</button>
    <button onclick="tap()">Tap!</button>
    <button onclick="disconnect()">Disconnect</button>
  </body>
  <script src="../dist/index.umd.js"></script>
  <script>
    const charismaUrl = "https://charisma-server-play.meh";

    let playthrough;
    let conversation;

    async function start() {
      const {
        Playthrough,
        Speaker,
        Microphone,
        createPlaythroughToken,
        createConversation,
        setGlobalBaseUrl,
      } = CharismaSDK;

      setGlobalBaseUrl(charismaUrl);

      const token = await createPlaythroughToken({ storyId: 27 });
      const conversationId = await createConversation(token);

      playthrough = new Playthrough(token);
      const speaker = new Speaker();
      const microphone = new Microphone();

      const timeout = 10000;

      conversation = playthrough.joinConversation(conversationId);
      conversation.on("start-typing", () => console.log("started typing"));
      conversation.on("stop-typing", () => console.log("stopped typing"));
      conversation.on("message", (message) => {
        microphone.resetTimeout(timeout);
        console.log(message.message.text);
        if (message.message.speech) {
          speaker.play(message.message.speech.audio);
        }
      });
      conversation.on("playback-start", () => console.log("playback start"));
      conversation.on("playback-stop", () => console.log("playback stop"));
      conversation.setSpeechConfig({
        encoding: "mp3",
        output: "buffer",
      });

      microphone.on("timeout", () => console.log("Timed out!"));
      microphone.on("recognise", (text) => {
        console.log("recognise", text);
        conversation.reply({ text });
      });
      microphone.on("recognise-interim", (text) => {
        console.log("recognise-interim", text);
        microphone.resetTimeout(timeout);
      });

      let started = false;
      playthrough.on("connection-status", (status) => {
        console.log("connection status", status);
        if (status === "connected" && !started) {
          conversation.start();
          started = true;
        }
      });

      playthrough.connect();

      microphone.startListening(timeout);
    }

    function tap() {
      conversation.tap();
    }

    function disconnect() {
      playthrough.disconnect();
    }
  </script>
</html>
